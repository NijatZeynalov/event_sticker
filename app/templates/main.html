<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DairÉ™vi MÉ™tn Generatoru</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .settings-toggle-btn {
            background-color: #e9e9e9;
            border: 1px solid #ccc;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: block;
            width: 100%;
            text-align: center;
        }

        .controls {
            display: none; /* Ayarlar baÅŸlanÄŸÄ±cda gizlidir */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            color: #333;
        }

        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="range"] {
            width: 100%;
        }

        .preview-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 620px; /* 600px + padding */
            background: #f8f8f8;
            border-radius: 10px;
            position: relative;
        }

        .circular-container {
            position: relative;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .circular-image {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            border-radius: 50%;
            overflow: hidden;
        }

        .circular-image img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; /* HÉ™miÅŸÉ™ Ã¶rtmÉ™ rejimindÉ™ olacaq */
            border-radius: 50%;
        }

        .text-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ‰ArtÄ±q, sonuncu addÄ±mdasan</h1>

        <button id="toggleSettingsBtn" class="settings-toggle-btn">Ã–zÉ™llÉ™ÅŸdir</button>

        <div class="controls" id="controlsPanel">
            <div class="control-group">
                <label for="textInput">MÉ™tn:</label>
                <input type="text" id="textInput" value="{{ default_text }}" placeholder="MÉ™tninizi daxil edin">
            </div>

            <div class="control-group">
                <label for="fontSize">Åžrift Ã–lÃ§Ã¼sÃ¼:</label>
                <input type="range" id="fontSize" min="10" max="60" value="30">
                <span id="fontSizeValue">30px</span>
            </div>

            <div class="control-group">
                <label for="textColor">MÉ™tn RÉ™ngi:</label>
                <input type="color" id="textColor" value="#333333">
            </div>

            <div class="control-group">
                <label for="letterSpacing">HÉ™rflÉ™r ArasÄ± MÉ™safÉ™:</label>
                <input type="range" id="letterSpacing" min="1" max="30" value="10" step="0.5">
                <span id="letterSpacingValue">10px</span>
            </div>

            <div class="control-group">
                <label for="borderWidth">Ã‡É™rÃ§ivÉ™ QalÄ±nlÄ±ÄŸÄ±:</label>
                <input type="range" id="borderWidth" min="40" max="150" value="70">
                <span id="borderWidthValue">70px</span>
            </div>

            <div class="control-group">
                <label for="textPosition">MÉ™tnin MÃ¶vqeyi:</label>
                <select id="textPosition">
                    <option value="top">YuxarÄ±</option>
                    <option value="bottom">AÅŸaÄŸÄ±</option>
                </select>
            </div>
        </div>

        <div class="preview-container">
            <div class="circular-container" id="circularContainer">
                <div class="circular-image" id="circularImage">
                    <img id="previewImage" src="{{ url_for('generated_image', image_id=generated_image_id) }}" alt="HÉ™diyyÉ™ SÉ™bÉ™ti">
                </div>

                <div class="text-overlay">
                    <svg width="100%" height="100%" id="textSvg" preserveAspectRatio="xMidYMid meet">
                         <defs>
                            <path id="textPath" d=""></path>
                        </defs>
                        <text id="curvedText" font-family="Arial, sans-serif" font-weight="bold" text-anchor="middle" dominant-baseline="middle">
                            <textPath href="#textPath" startOffset="50%"></textPath>
                        </text>
                    </svg>
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="download-btn" onclick="downloadImage()">Stickeri Ã§ap et</button>
            <button class="download-btn" onclick="window.location.href='{{ url_for('home') }}'">Yeni sticker yarat</button>
        </div>
    </div>

    <script>
        const previewImage = document.getElementById('previewImage');
        const textInput = document.getElementById('textInput');
        const fontSize = document.getElementById('fontSize');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const textColor = document.getElementById('textColor');
        const letterSpacing = document.getElementById('letterSpacing');
        const letterSpacingValue = document.getElementById('letterSpacingValue');
        const borderWidth = document.getElementById('borderWidth');
        const borderWidthValue = document.getElementById('borderWidthValue');
        const textPosition = document.getElementById('textPosition');
        const circularContainer = document.getElementById('circularContainer');
        const circularImage = document.getElementById('circularImage');
        const curvedText = document.getElementById('curvedText');
        const textSvg = document.getElementById('textSvg');
        const textPath = document.getElementById('textPath');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const controlsPanel = document.getElementById('controlsPanel');

        toggleSettingsBtn.addEventListener('click', () => {
            const isHidden = controlsPanel.style.display === 'none' || controlsPanel.style.display === '';
            if (isHidden) {
                controlsPanel.style.display = 'grid';
                toggleSettingsBtn.textContent = 'Ã–zÉ™llÉ™ÅŸdirmÉ™ni baÄŸla';
            } else {
                controlsPanel.style.display = 'none';
                toggleSettingsBtn.textContent = 'Ã–zÉ™llÉ™ÅŸdir';
            }
        });

        function updateAll() {
            const totalSize = 600; // Ã–lÃ§Ã¼ sabit olaraq tÉ™yin edildi
            const border = parseInt(borderWidth.value, 10);
            const imageInnerSize = totalSize - (border * 2);

            circularContainer.style.width = totalSize + 'px';
            circularContainer.style.height = totalSize + 'px';
            circularImage.style.width = imageInnerSize + 'px';
            circularImage.style.height = imageInnerSize + 'px';

            textSvg.setAttribute('viewBox', `0 0 ${totalSize} ${totalSize}`);
            curvedText.querySelector('textPath').textContent = textInput.value;
            curvedText.style.fontSize = fontSize.value + 'px';
            curvedText.style.fill = textColor.value;
            curvedText.style.letterSpacing = letterSpacing.value + 'px';

            const center = totalSize / 2;
            const textRadius = (imageInnerSize / 2) + (border / 2);
            const startX = center - textRadius;
            const endX = center + textRadius;
            const y = center;

            if (textPosition.value === 'bottom') {
                 textPath.setAttribute('d', `M ${startX},${y} A ${textRadius},${textRadius} 0 0 0 ${endX},${y}`);
            } else {
                 textPath.setAttribute('d', `M ${startX},${y} A ${textRadius},${textRadius} 0 0 1 ${endX},${y}`);
            }
        }

        [textInput, fontSize, textColor, letterSpacing, borderWidth, textPosition].forEach(el => {
            el.addEventListener('input', updateAll);
        });

        fontSize.addEventListener('input', () => fontSizeValue.textContent = fontSize.value + 'px');
        letterSpacing.addEventListener('input', () => letterSpacingValue.textContent = letterSpacing.value + 'px');
        borderWidth.addEventListener('input', () => borderWidthValue.textContent = borderWidth.value + 'px');

        function downloadImage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const totalSize = 600; // YÃ¼klÉ™mÉ™ Ã¼Ã§Ã¼n Ã¶lÃ§Ã¼ sabit olaraq tÉ™yin edildi
            const border = parseInt(borderWidth.value);
            const imageInnerSize = totalSize - (border * 2);

            canvas.width = totalSize;
            canvas.height = totalSize;

            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(totalSize / 2, totalSize / 2, totalSize / 2, 0, 2 * Math.PI);
            ctx.fill();

            const mainImage = new Image();
            mainImage.crossOrigin = 'anonymous';
            mainImage.onload = function() {
                // ÅžÉ™kil hÉ™miÅŸÉ™ "cover" rejimindÉ™ Ã§É™kilÉ™cÉ™k
                ctx.save();
                ctx.beginPath();
                ctx.arc(totalSize / 2, totalSize / 2, imageInnerSize / 2, 0, 2 * Math.PI);
                ctx.clip();

                const imgRatio = mainImage.naturalWidth / mainImage.naturalHeight;
                let newWidth, newHeight;
                if (imgRatio > 1) {
                    newHeight = imageInnerSize;
                    newWidth = newHeight * imgRatio;
                } else {
                    newWidth = imageInnerSize;
                    newHeight = newWidth / imgRatio;
                }
                const x = border + (imageInnerSize - newWidth) / 2;
                const y = border + (imageInnerSize - newHeight) / 2;
                ctx.drawImage(mainImage, x, y, newWidth, newHeight);
                ctx.restore();

                const svgString = new XMLSerializer().serializeToString(textSvg);
                const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);

                const svgImage = new Image();
                svgImage.onload = function() {
                    ctx.drawImage(svgImage, 0, 0, totalSize, totalSize);
                    URL.revokeObjectURL(url);
                    const link = document.createElement('a');
                    link.download = 'dairÉ™vi-ÅŸÉ™kil.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
                svgImage.src = url;
            };
            mainImage.src = "{{ url_for('generated_image', image_id=generated_image_id) }}";
        }

        updateAll();
    </script>
</body>
</html>
